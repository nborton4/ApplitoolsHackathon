'use strict';

const getHrefAttr = require('./getHrefAttr');
const isLinkToStyleSheet = require('./isLinkToStyleSheet');

function makeExtractCssFromNode({getCssFromCache, absolutizeUrl}) {
  return function extractCssFromNode(node, baseUrl) {
    let cssText, resourceUrl, isUnfetched;
    if (isStyleElement(node)) {
      cssText = Array.from(node.childNodes)
        .map(node => node.nodeValue)
        .join('');
      resourceUrl = baseUrl;
    } else if (isLinkToStyleSheet(node)) {
      resourceUrl = absolutizeUrl(getHrefAttr(node), baseUrl);
      cssText = getCssFromCache(resourceUrl);
      if (cssText === undefined) {
        isUnfetched = true;
      }
    }
    return {cssText, resourceUrl, isUnfetched};
  };
}

function isStyleElement(node) {
  return node.nodeName && node.nodeName.toUpperCase() === 'STYLE';
}

module.exports = makeExtractCssFromNode;
